<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libcmml: Example Documentation</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>cmml-validate.c</h1>This is the full source code of the cmml-validate program, which parses a CMML instance document and validates it against the cmml.dtd returning true/false. In case of an error the faulty tag including line and col number is reported. It also spits out warnings for strange stuff. <div class="fragment"><pre><span class="comment">/* Copyright (C) 2003 CSIRO Australia</span>
<span class="comment"></span>
<span class="comment">   Redistribution and use in source and binary forms, with or without</span>
<span class="comment">   modification, are permitted provided that the following conditions</span>
<span class="comment">   are met:</span>
<span class="comment">   </span>
<span class="comment">   - Redistributions of source code must retain the above copyright</span>
<span class="comment">   notice, this list of conditions and the following disclaimer.</span>
<span class="comment">   </span>
<span class="comment">   - Redistributions in binary form must reproduce the above copyright</span>
<span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
<span class="comment">   documentation and/or other materials provided with the distribution.</span>
<span class="comment">   </span>
<span class="comment">   - Neither the name of the CSIRO nor the names of its</span>
<span class="comment">   contributors may be used to endorse or promote products derived from</span>
<span class="comment">   this software without specific prior written permission.</span>
<span class="comment">   </span>
<span class="comment">   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="comment">   ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="comment">   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A</span>
<span class="comment">   PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE ORGANISATION OR</span>
<span class="comment">   CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,</span>
<span class="comment">   EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,</span>
<span class="comment">   PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR</span>
<span class="comment">   PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="comment">   LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="comment">   NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="comment">   SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="comment">*/</span>

<span class="preprocessor">#include "config.h"</span>

<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<span class="preprocessor">#include &lt;ctype.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;errno.h&gt;</span>

<span class="preprocessor">#ifndef WIN32</span>
<span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifdef HAVE_GETOPT_H</span>
<span class="preprocessor"></span><span class="preprocessor">#include &lt;getopt.h&gt;</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#include &lt;<a class="code" href="cmml_8h.html">cmml.h</a>&gt;</span>

<span class="preprocessor">#define BUFSIZE 100000</span>
<span class="preprocessor"></span>
<span class="comment">/*</span>
<span class="comment">#define DEBUG</span>
<span class="comment">*/</span>

<span class="keyword">static</span> <span class="keywordtype">int</span> verbose;

<span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="a44"></a><a class="code" href="cmml-validate_8c.html#a2">PrintUsage</a>(<span class="keywordtype">char</span> *prog) {
  fprintf(stderr, <span class="stringliteral">"Usage: %s [options] filename\n"</span>, prog);
  fprintf(stderr, <span class="stringliteral">"Validate a CMML file.\n\n"</span>);
  fprintf(stderr, <span class="stringliteral">"Possible options:\n"</span>);
<span class="preprocessor">#ifdef HAVE_GETOPT_LONG</span>
<span class="preprocessor"></span>  fprintf(stderr, <span class="stringliteral">"  -i clip_id, --id clip_id\n"</span>);
  fprintf(stderr, <span class="stringliteral">"                 Start parsing from the named clip.\n"</span>);
  fprintf(stderr, <span class="stringliteral">"  -s seconds, --sec seconds\n"</span>);
  fprintf(stderr, <span class="stringliteral">"                 Start parsing from the given seconds offset\n"</span>);
  fprintf(stderr, <span class="stringliteral">"  -u utc,     --utc utc\n"</span>);
  fprintf(stderr, <span class="stringliteral">"                 Start parsing from the given utc time\n"</span>);
  fprintf(stderr, <span class="stringliteral">"  -b, --verbose  Output parsed file to stdout\n"</span>);
  fprintf(stderr, <span class="stringliteral">"  -h, --help     Display this help information\n"</span>);
  fprintf(stderr, <span class="stringliteral">"  -v, --version  Display version information\n"</span>);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  fprintf(stderr, <span class="stringliteral">"  -i clip_id     Start parsing from the named clip\n"</span>);
  fprintf(stderr, <span class="stringliteral">"  -s seconds     Start parsing from the given seconds offset\n"</span>);
  fprintf(stderr, <span class="stringliteral">"  -u utc         Start parsing from the given utc time\n"</span>);
  fprintf(stderr, <span class="stringliteral">"  -b             Output parsed file to stdout\n"</span>);
  fprintf(stderr, <span class="stringliteral">"  -h             Display this help information\n"</span>);
  fprintf(stderr, <span class="stringliteral">"  -v             Display version information\n"</span>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  fprintf(stderr, <span class="stringliteral">"\nPlease report bugs to &lt;libcmml-devel@cmis.csiro.au&gt;.\n"</span>);
  exit(1);
}

<span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="a45"></a><a class="code" href="cmml-validate_8c.html#a3">read_stream</a> (<a class="code" href="cmml_8h.html#a0">CMML</a> * cmml, <span class="keyword">const</span> <a name="_a46"></a><a class="code" href="structCMML__Stream.html">CMML_Stream</a> * stream, <span class="keywordtype">void</span> * user_data) {
  <span class="keywordtype">char</span> buf[<a class="code" href="cmml-validate_8c.html#a0">BUFSIZE</a>];
  <a name="_a47"></a><a class="code" href="structCMML__Error.html">CMML_Error</a> * err;
  <span class="keywordflow">if</span> ((err = <a name="a48"></a><a class="code" href="cmml_8h.html#a49">cmml_get_last_error</a>(cmml)) != NULL) {
    <a name="a49"></a><a class="code" href="cmml_8h.html#a81">cmml_error_snprint</a>(buf, BUFSIZE, err, cmml);
    fprintf(stderr, <span class="stringliteral">"cmml-validate: Parsing stream tag %s\n"</span>, buf);
    fprintf(stderr, <span class="stringliteral">"cmml-validate: Non-recoverable error\n"</span>);
    <span class="keywordflow">return</span> -1;
  } <span class="keywordflow">else</span> {
    <span class="comment">/* print stream */</span>
    <span class="keywordflow">if</span> (verbose) {
      <a name="a50"></a><a class="code" href="cmml_8h.html#a76">cmml_stream_pretty_snprint</a> (buf, BUFSIZE, (<a class="code" href="structCMML__Stream.html">CMML_Stream</a> *) stream);
      fprintf(stdout, <span class="stringliteral">"%s\n"</span>, buf);
    }
  }  <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="a51"></a><a class="code" href="cmml-validate_8c.html#a4">read_head</a> (<a class="code" href="cmml_8h.html#a0">CMML</a> * cmml, <span class="keyword">const</span> <a name="_a52"></a><a class="code" href="structCMML__Head.html">CMML_Head</a> * head, <span class="keywordtype">void</span> * user_data) {
  <span class="keywordtype">char</span> buf[<a class="code" href="cmml-validate_8c.html#a0">BUFSIZE</a>];
  <a class="code" href="structCMML__Error.html">CMML_Error</a> * err;
  <span class="keywordflow">if</span> ((err = <a class="code" href="cmml_8h.html#a49">cmml_get_last_error</a>(cmml)) != NULL) {
    <a class="code" href="cmml_8h.html#a81">cmml_error_snprint</a>(buf, BUFSIZE, err, cmml);
    fprintf(stderr, <span class="stringliteral">"cmml-validate: Parsing head tag %s\n"</span>, buf);
    fprintf(stderr, <span class="stringliteral">"cmml-validate: Non-recoverable error\n"</span>);
    <span class="keywordflow">return</span> -1;
  } <span class="keywordflow">else</span> {
    <span class="keywordflow">if</span> (verbose) {
      <a name="a53"></a><a class="code" href="cmml_8h.html#a78">cmml_head_pretty_snprint</a> (buf, BUFSIZE, (<a class="code" href="structCMML__Head.html">CMML_Head</a> *) head);
      fprintf(stdout, <span class="stringliteral">"%s\n"</span>, buf);
    }
  }
  <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="a54"></a><a class="code" href="cmml-validate_8c.html#a5">read_clip</a> (<a class="code" href="cmml_8h.html#a0">CMML</a> * cmml, <span class="keyword">const</span> <a name="_a55"></a><a class="code" href="structCMML__Clip.html">CMML_Clip</a> * clip, <span class="keywordtype">void</span> * user_data) {
  <span class="keywordtype">char</span> buf[<a class="code" href="cmml-validate_8c.html#a0">BUFSIZE</a>];
  <a class="code" href="structCMML__Error.html">CMML_Error</a> * err;
  <span class="keywordflow">if</span> ((err = <a class="code" href="cmml_8h.html#a49">cmml_get_last_error</a>(cmml)) != NULL) {
    <a class="code" href="cmml_8h.html#a81">cmml_error_snprint</a>(buf, BUFSIZE, err, cmml);
    fprintf(stderr, <span class="stringliteral">"cmml-validate: Parsing clip %s\n"</span>, buf);
    fprintf(stderr, <span class="stringliteral">"cmml-validate: Skipping clip\n\n"</span>);
    <span class="keywordflow">return</span> -1;
  } <span class="keywordflow">else</span> {
    <span class="keywordflow">if</span> (verbose) {
      <a name="a56"></a><a class="code" href="cmml_8h.html#a80">cmml_clip_pretty_snprint</a> (buf, BUFSIZE, (<a class="code" href="structCMML__Clip.html">CMML_Clip</a> *) clip);
      fprintf(stdout, <span class="stringliteral">"%s\n"</span>, buf);
    }
  }
  <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> <a name="a57"></a><a class="code" href="cmml-validate_8c.html#a6">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
  <span class="keywordtype">char</span> *pathfile = NULL;
  <span class="keywordtype">int</span> i;
  <span class="keywordtype">char</span> buf[<a class="code" href="cmml-validate_8c.html#a0">BUFSIZE</a>];
  <a class="code" href="cmml_8h.html#a0">CMML</a> * doc;
  <a class="code" href="structCMML__Error.html">CMML_Error</a> * err;
  <a name="_a58"></a><a class="code" href="structCMML__Preamble.html">CMML_Preamble</a> * pre;
  <span class="keywordtype">long</span> n = 0;
  <span class="keywordtype">char</span> * clip_id = NULL;
  <span class="keywordtype">double</span> secs = -1.0;
  <span class="keywordtype">char</span> * utc = NULL;
  <span class="keywordtype">int</span> sloppy = 0;
  verbose = 0;

  <span class="keywordflow">while</span> (1) {
    <span class="keywordtype">char</span> * optstring = <span class="stringliteral">"hvbyi:s:u:"</span>;

<span class="preprocessor">#ifdef HAVE_GETOPT_LONG</span>
<span class="preprocessor"></span>    <span class="keyword">static</span> <span class="keyword">struct </span>option long_options[] = {
      {<span class="stringliteral">"help"</span>,no_argument,0,<span class="charliteral">'h'</span>},
      {<span class="stringliteral">"version"</span>,no_argument,0, <span class="charliteral">'v'</span>},
      {<span class="stringliteral">"verbose"</span>,no_argument,0,<span class="charliteral">'b'</span>},
      {<span class="stringliteral">"sloppy"</span>,no_argument,0,<span class="charliteral">'y'</span>},
      {<span class="stringliteral">"id"</span>,required_argument,0,<span class="charliteral">'i'</span>},
      {<span class="stringliteral">"sec"</span>,required_argument,0,<span class="charliteral">'s'</span>},
      {<span class="stringliteral">"utc"</span>,required_argument,0,<span class="charliteral">'u'</span>},
      {0,0,0,0}
    };

    i = getopt_long(argc, argv, optstring, long_options, NULL);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    i = getopt(argc, argv, optstring);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordflow">if</span> (i == -1) <span class="keywordflow">break</span>;
    <span class="keywordflow">if</span> (i == <span class="charliteral">':'</span>) <a class="code" href="cmml-validate_8c.html#a2">PrintUsage</a>(argv[0]);

    <span class="keywordflow">switch</span> (i) {
    <span class="keywordflow">case</span> <span class="charliteral">'h'</span>: <span class="comment">/* help */</span>
      <a class="code" href="cmml-validate_8c.html#a2">PrintUsage</a>(argv[0]);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'v'</span>: <span class="comment">/* version */</span>
      fprintf(stdout, <span class="stringliteral">"cmml-validate version "</span> VERSION <span class="stringliteral">"\n"</span>);
      fprintf(stdout, <span class="stringliteral">"# cmml-validate, Copyright (C) 2003 CSIRO Australia www.csiro.au ; www.annodex.net\n"</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'i'</span>: <span class="comment">/* clip_id */</span>
      clip_id = optarg;
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'s'</span>: <span class="comment">/* seconds */</span>
      <span class="keywordflow">if</span> (!isalpha(optarg[0])) {
        secs = atof(optarg);
      }
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'u'</span>: <span class="comment">/* utc */</span>
      utc = optarg;
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'y'</span>: <span class="comment">/* sloppy */</span>
      sloppy = 1;
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'b'</span>: <span class="comment">/* verbose */</span>
      verbose = 1;
      <span class="keywordflow">break</span>;
    <span class="keywordflow">default</span>:
      <span class="keywordflow">break</span>;
    }
  }

  <span class="comment">/* more arguments that were not parsed */</span>
  <span class="keywordflow">if</span> (optind &gt; argc) {
    <a class="code" href="cmml-validate_8c.html#a2">PrintUsage</a>(argv[0]);
  }

  <span class="comment">/* no filename given? */</span>
  <span class="keywordflow">if</span> (optind == argc) {
    pathfile = <span class="stringliteral">"-"</span>;
  } <span class="keywordflow">else</span> {
    pathfile = argv[optind++];
  }

  <span class="comment">/* try open file for parsing and setup cmml parsing */</span>
  errno=0;
  <span class="keywordflow">if</span> (strcmp (pathfile, <span class="stringliteral">"-"</span>) == 0) {
    doc = <a name="a59"></a><a class="code" href="cmml_8h.html#a38">cmml_new</a> (stdin);
  } <span class="keywordflow">else</span> {
    doc = <a name="a60"></a><a class="code" href="cmml_8h.html#a37">cmml_open</a> (pathfile);
  }

  <span class="keywordflow">if</span> (doc == NULL) {
    <span class="keywordflow">if</span> (errno == 0) {
      fprintf(stderr, <span class="stringliteral">"%s: %s: CMML error opening file\n"</span>, argv[0], pathfile);
    } <span class="keywordflow">else</span> {
      fprintf(stderr, <span class="stringliteral">"%s: %s: %s\n"</span>, argv[0], pathfile, strerror(errno));
    }
    <a class="code" href="cmml-validate_8c.html#a2">PrintUsage</a>(argv[0]);
  }

  <span class="comment">/* turn on sloppy parsing if requested */</span>
  <span class="keywordflow">if</span> (sloppy) {
    <a name="a61"></a><a class="code" href="cmml_8h.html#a43">cmml_set_sloppy</a>(doc, 1);
  }

  <span class="comment">/* print preamble */</span>
  <span class="keywordflow">if</span> (verbose) {
    pre = <a name="a62"></a><a class="code" href="cmml_8h.html#a44">cmml_get_preamble</a>(doc);
    <a name="a63"></a><a class="code" href="cmml_8h.html#a73">cmml_preamble_snprint</a>(buf, BUFSIZE, pre);
    fprintf(stdout, <span class="stringliteral">"%s\n"</span>, buf);
  }

  <span class="comment">/* seek to clip_id; if not found, to file end */</span>
  <span class="keywordflow">if</span> (clip_id != NULL) {
    <span class="comment">/* register callbacks */</span>
    <a name="a64"></a><a class="code" href="cmml_8h.html#a41">cmml_set_read_callbacks</a> (doc, read_stream, read_head, NULL, NULL);
    <a name="a65"></a><a class="code" href="cmml_8h.html#a54">cmml_skip_to_id</a> (doc, clip_id);
  }

  <span class="comment">/* seek to time offset; if not found, to file end */</span>
  <span class="keywordflow">if</span> (secs &gt; 0 || utc != NULL) {
    <span class="comment">/* register callbacks */</span>
    <a class="code" href="cmml_8h.html#a41">cmml_set_read_callbacks</a> (doc, read_stream, read_head, NULL, NULL);
    <span class="keywordflow">if</span> (secs &gt; 0) {
      <a name="a66"></a><a class="code" href="cmml_8h.html#a52">cmml_skip_to_secs</a> (doc, secs);
    } <span class="keywordflow">else</span> { <span class="comment">/* if (utc != NULL) { */</span>
      <a name="a67"></a><a class="code" href="cmml_8h.html#a53">cmml_skip_to_utc</a> (doc, utc);
    }
  }

  <span class="comment">/* register callbacks */</span>
  <a class="code" href="cmml_8h.html#a41">cmml_set_read_callbacks</a> (doc, read_stream, read_head, read_clip, NULL);

  <span class="comment">/* read document frame-wise and check against CMML.dtd */</span>
  <span class="keywordflow">while</span> ((n = <a name="a68"></a><a class="code" href="cmml_8h.html#a42">cmml_read</a> (doc, BUFSIZE)) &gt; 0) {
    <span class="comment">/* if error reading, print and exit */</span>
    <span class="keywordflow">if</span> ((err = <a class="code" href="cmml_8h.html#a49">cmml_get_last_error</a>(doc)) != NULL &amp;&amp; err-&gt;<a name="a69"></a><a class="code" href="structCMML__Error.html#o0">type</a> != <a class="code" href="cmml_8h.html#a114a20">CMML_EOF</a>) {
      <span class="keywordtype">char</span> *filename;
      filename = (strrchr(pathfile, <span class="charliteral">'/'</span>) == NULL ? pathfile
                  : strrchr(pathfile, <span class="charliteral">'/'</span>)+1);
      <a class="code" href="cmml_8h.html#a81">cmml_error_snprint</a>(buf, BUFSIZE, err, doc);
      fprintf (stderr, <span class="stringliteral">"%s:%s\n"</span>, filename, buf);
      <span class="keywordflow">goto</span> cleanup;
    }
  }

  err = <a class="code" href="cmml_8h.html#a49">cmml_get_last_error</a>(doc);
  <span class="keywordflow">if</span> (n == -1 || (err!=NULL &amp;&amp; err-&gt;<a class="code" href="structCMML__Error.html#o0">type</a> != <a class="code" href="cmml_8h.html#a114a20">CMML_EOF</a>)) {
      <span class="keywordtype">char</span> *filename;
      filename = (strrchr(pathfile, <span class="charliteral">'/'</span>) == NULL ? pathfile
                  : strrchr(pathfile, <span class="charliteral">'/'</span>)+1);
      <a class="code" href="cmml_8h.html#a81">cmml_error_snprint</a>(buf, BUFSIZE, err, doc);
      fprintf (stderr, <span class="stringliteral">"%s:%s\n"</span>, filename, buf);
      <span class="keywordflow">goto</span> cleanup;
  }

  <span class="comment">/* write end tag */</span>
  <span class="keywordflow">if</span> (verbose) {
    fprintf(stdout, <span class="stringliteral">"&lt;/cmml&gt;\n"</span>);
  }
  
 cleanup:
  <span class="comment">/* clean up */</span>
  <a name="a70"></a><a class="code" href="cmml_8h.html#a40">cmml_close</a>(doc);

  <span class="keywordflow">return</span> 0;
}
</pre></div> <hr size="1"><address style="align: right;"><small>Generated on Thu Mar 11 13:52:17 2004 for libcmml by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
