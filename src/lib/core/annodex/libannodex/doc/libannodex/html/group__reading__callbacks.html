<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libannodex: Advanced management of AnxRead callbacks</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>Advanced management of AnxRead callbacks<br>
<small>
[<a class="el" href="group__reading.html">Reading from Annodex media</a>]</small>
</h1>You retain control of the number of bytes read or input, and the callbacks you provide can instruct libannodex to immediately return control back to your application.<h2><a class="anchor" name="rcb_list">
Callbacks</a></h2>
It is not required to implement all callbacks.<h2><a class="anchor" name="rcb_retvals">
Return values</a></h2>
<ul>
<li>ANX_CONTINUE on success, and to inform anx_read*() functions to continue on to the next packet</li><li>ANX_STOP_OK on success, to inform anx_read*() functions to return without further processing</li><li>ANX_STOP_ERR on error, to inform anx_read*() functions to return without further processing</li></ul>
<p>
These mechanisms are illustrated in src/examples/print-lots.c:<p>
<div class="fragment"><pre>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="annodex_8h.html">annodex/annodex.h</a>&gt;</span>

<span class="keyword">struct </span><a class="code" href="structmy__data.html">my_data</a> {
  <span class="keywordtype">char</span> * filename;
  <span class="keywordtype">long</span> interesting_serialno;
  <span class="keywordtype">int</span> interesting_raw_packets;
  <span class="keywordtype">int</span> done;
};

<span class="keyword">static</span> <span class="keywordtype">int</span>
read_stream (<a class="code" href="anx__types_8h.html#a0">ANNODEX</a> * anx, <span class="keywordtype">double</span> timebase, <span class="keywordtype">char</span> * utc, <span class="keywordtype">void</span> * user_data)
{
  <span class="keyword">struct </span><a class="code" href="structmy__data.html">my_data</a> * happy = (<span class="keyword">struct </span><a class="code" href="structmy__data.html">my_data</a> *) user_data;

  printf (<span class="stringliteral">"Welcome to %s! The timebase is %f\n"</span>, happy-&gt;filename, timebase);
  <span class="keywordflow">return</span> ANX_CONTINUE;
}

<span class="keyword">static</span> <span class="keywordtype">int</span>
read_track (<a class="code" href="anx__types_8h.html#a0">ANNODEX</a> * anx, <span class="keywordtype">long</span> serialno, <span class="keywordtype">char</span> * id, <span class="keywordtype">char</span> * content_type,
            <a class="code" href="anx__int64_8h.html#a0">anx_int64_t</a> granule_rate_n, <a class="code" href="anx__int64_8h.html#a0">anx_int64_t</a> granule_rate_d,
            <span class="keywordtype">int</span> nr_header_packets, <span class="keywordtype">void</span> * user_data)
{
  <span class="keyword">struct </span><a class="code" href="structmy__data.html">my_data</a> * happy = (<span class="keyword">struct </span><a class="code" href="structmy__data.html">my_data</a> *) user_data;

  <span class="comment">/* Ignore the annotations track, we don't find it interesting! */</span>
  <span class="keywordflow">if</span> (!strncmp (content_type, <span class="stringliteral">"text/x-cmml"</span>, 12)) <span class="keywordflow">return</span> ANX_CONTINUE;

  printf (<span class="stringliteral">"Our first track has content-type %s and granule rate %ld/%ld.\n"</span>,
          content_type, (<span class="keywordtype">long</span>)granule_rate_n, (<span class="keywordtype">long</span>)granule_rate_d);

  printf (<span class="stringliteral">"We will remember it by its serial number %ld "</span>
          <span class="stringliteral">"and mark it with crosses.\n"</span>, serialno);
  happy-&gt;interesting_serialno = serialno;

  <span class="comment">/* We don't care about any other tracks! */</span>
  <a class="code" href="anx__read_8h.html#a7">anx_set_read_track_callback</a> (anx, NULL, NULL);

  <span class="keywordflow">return</span> ANX_CONTINUE;
}

<span class="keyword">static</span> <span class="keywordtype">int</span>
read_raw (<a class="code" href="anx__types_8h.html#a0">ANNODEX</a> * annodex, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * buf, <span class="keywordtype">long</span> n,
            <span class="keywordtype">long</span> serialno, <a class="code" href="anx__int64_8h.html#a0">anx_int64_t</a> granulepos, <span class="keywordtype">void</span> * user_data)
{
  <span class="keyword">struct </span><a class="code" href="structmy__data.html">my_data</a> * happy = (<span class="keyword">struct </span><a class="code" href="structmy__data.html">my_data</a> *) user_data;

  <span class="keywordflow">if</span> (happy-&gt;done) {
    putchar (<span class="charliteral">'!'</span>);
  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (serialno == happy-&gt;interesting_serialno) {
    happy-&gt;interesting_raw_packets++;
    putchar (<span class="charliteral">'+'</span>);
  } <span class="keywordflow">else</span> {
    putchar (<span class="charliteral">'.'</span>);
  }

  <span class="keywordflow">return</span> ANX_CONTINUE;
}

<span class="keyword">static</span> <span class="keywordtype">int</span>
read_clip3 (<a class="code" href="anx__types_8h.html#a0">ANNODEX</a> * anx, <span class="keyword">const</span> AnxClip * clip, <span class="keywordtype">void</span> * user_data)
{
  <span class="keyword">struct </span><a class="code" href="structmy__data.html">my_data</a> * happy = (<span class="keyword">struct </span><a class="code" href="structmy__data.html">my_data</a> *) user_data;

  printf (<span class="stringliteral">"\nAnd the third clip links to %s\n"</span>, clip-&gt;anchor_href);

  happy-&gt;done = 1;

  printf (<span class="stringliteral">"This completes our whirlwind tour of the first three clips!\n"</span>);
  <span class="keywordflow">return</span> ANX_STOP_OK;
}

<span class="keyword">static</span> <span class="keywordtype">int</span>
read_clip2 (<a class="code" href="anx__types_8h.html#a0">ANNODEX</a> * anx, <span class="keyword">const</span> AnxClip * clip, <span class="keywordtype">void</span> * user_data)
{
  printf (<span class="stringliteral">"\nThe second clip links to %s\n"</span>, clip-&gt;anchor_href);
  <a class="code" href="anx__read_8h.html#a11">anx_set_read_clip_callback</a> (anx, read_clip3, user_data);
  <span class="keywordflow">return</span> ANX_CONTINUE;
}

<span class="keyword">static</span> <span class="keywordtype">int</span>
read_clip1 (<a class="code" href="anx__types_8h.html#a0">ANNODEX</a> * anx, <span class="keyword">const</span> AnxClip * clip, <span class="keywordtype">void</span> * user_data)
{
  printf (<span class="stringliteral">"\nThe first clip links to %s\n"</span>, clip-&gt;anchor_href);
  <a class="code" href="anx__read_8h.html#a11">anx_set_read_clip_callback</a> (anx, read_clip2, user_data);
  <span class="keywordflow">return</span> ANX_CONTINUE;
}

<span class="keywordtype">int</span>
main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
  <a class="code" href="anx__types_8h.html#a0">ANNODEX</a> * anx = NULL;
  <span class="keyword">struct </span><a class="code" href="structmy__data.html">my_data</a> me;
  <span class="keywordtype">long</span> n;

  <span class="keywordflow">if</span> (argc != 2) {
    fprintf (stderr, <span class="stringliteral">"Usage: %s file.anx\n"</span>, argv[0]);
    exit (1);
  }

  me.<a class="code" href="structmy__data.html#o0">filename</a> = argv[1];
  me.<a class="code" href="structmy__data.html#o1">interesting_serialno</a> = -1;
  me.<a class="code" href="structmy__data.html#o2">interesting_raw_packets</a> = 0;
  me.<a class="code" href="structmy__data.html#o3">done</a> = 0;

  anx = <a class="code" href="anx__general_8h.html#a3">anx_open</a> (me.<a class="code" href="structmy__data.html#o0">filename</a>, ANX_READ);

  <a class="code" href="anx__read_8h.html#a5">anx_set_read_stream_callback</a> (anx, read_stream, &amp;me);
  <a class="code" href="anx__read_8h.html#a7">anx_set_read_track_callback</a> (anx, read_track, &amp;me);
  <a class="code" href="anx__read_8h.html#a13">anx_set_read_raw_callback</a> (anx, read_raw, &amp;me);
  <a class="code" href="anx__read_8h.html#a11">anx_set_read_clip_callback</a> (anx, read_clip1, &amp;me);

  <span class="keywordflow">while</span> (!me.<a class="code" href="structmy__data.html#o3">done</a> &amp;&amp; (n = <a class="code" href="anx__read_8h.html#a16">anx_read</a> (anx, 1024)) &gt; 0);

  printf (<span class="stringliteral">"%d packets from the first track (serialno %ld) were received\n"</span>,
          me.<a class="code" href="structmy__data.html#o2">interesting_raw_packets</a>, me.<a class="code" href="structmy__data.html#o1">interesting_serialno</a>);
  printf (<span class="stringliteral">"before the third clip.\n"</span>);

  <a class="code" href="anx__general_8h.html#a7">anx_close</a> (anx);

  exit (0);
}
</pre></div><p>
which produces output like: <pre><div>
Welcome to /tmp/alien_song.anx! The timebase is 20.000000
Our first track has mime-type video/x-theora and granule rate 1536/1.
We will remember it by its serial number 1810353996 and mark it with crosses.
+...+++++++++++++++++...................................++++++++++++++..........
......................++++++++++++..............................++++++++++++++++
++++..............................+++++++++++++.................................
...++++++++++++++++++++++................................++++++++++++++.........
........................++++++++++++++++....................................++++
++++++++++.......................................++++++++++++++.................
......+++++++++++++.......................+++++++++++++.........................
...+++++++++++++..................................+++++++++++++.................
......+++++++++++++...............................++++++++++++++................
..........+++++++++++..........................++++++++++++++...................
.....++++++++++++.......................++++++++++++........................++++
++++++++........................+++++++++++++........................+++++++++++
+++++.......................+++++++++++.......................+++++++++++++++++.
......................+++++++++++++........................++++++++++...........
.............+++++++++++.......................++++++++++++++++++...............
........++++++++........................+++++++++++++++++.......................
++++++++.......................+++++++++++++++++........................++++++++
++++++...........................+++++++++++........................++++++++++++
+++........................+++++++++++.......................++++++++++++++.....
.................++++++++++++++..............................++++++++++.........
.........................++++++++++++................................+++++++++++
+++...................................++++++
The first anchor links to <a href="http://www.mars.int/">http://www.mars.int/</a>
+
The second anchor links to <a href="http://www.pluto.int/">http://www.pluto.int/</a>
+++......................+++++++++++.............................+++++++++++....
...........................+++++++++++..........................................
.......+++++++++++++...........................+++++++++++......................
.......+</pre></div><p>
<pre><div>And the third anchor links to <a href="http://www.venus.int/">http://www.venus.int/</a>
This completes our whirlwind tour of the first three anchors!</pre></div><p>
<pre><div>639 packets from the first track (serialno 1810353996) were received
before the third anchor.</pre></div><p>
<pre><div> </pre></div> 
<p>
<table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 22 19:44:49 2004 for libannodex by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
